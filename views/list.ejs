<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8"/>
<title>Hash File Storage</title>
<script type="text/javascript" src="//code.jquery.com/jquery-2.2.4.min.js"></script>
<link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/4.3.0/css/bootstrap.min.css"/>
<link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/4.3.0/css/bootstrap-theme.min.css"/>
<script src="//maxcdn.bootstrapcdn.com/bootstrap/4.3.0/js/bootstrap.min.js"></script>
<link href="./colorbox.css" rel="stylesheet"/>
<script type="text/javascript" src="./jquery.colorbox-min.js"></script>
<script type="text/javascript" src="./cvi_busy_lib.js"></script>
<script>
$(function(){
  $.ajax({
    type: 'GET',
    url: '/api/file_ids',
    success: function( result ){
      result.ids.forEach( function( id ){
        var tr = '<tr>'
          + '<td>' + id + '</td>'
          + '<td><img src="/api/file/' + id + '" width="200"/></td>'
          + '<td><input type="button" class="btn btn-danger btn-xs" value="DEL" onClick="delFile(\'' + id + '\');"/></td>'
          + '</tr>';
        $('#table-body').append( tr );
      });
      var tr = '<tr>'
        + '<td> - </td>'
        + '<td><form name="frm" id="frm" method="POST" action="/api/file" enctype="multipart/form-data"><input class="form-control" type="file" id="file" name="file"/></form></td>'
        + '<td><input type="button" class="btn btn-success btn-xs" value="ADD" onClick="addFile();"/></td>'
        + '</tr>';
      $('#table-body').append( tr );
    },
    error: function( e0, e1, e2 ){
      console.log( e1 + " : " + e2 );
    }
  });
});

function downloadFile( id ){
  window.location.href = '/api/file/' + id + '?download=1';
}

function addFile(){
  var fd = new FormData();
  if( $("input[name='file']").val() != '' ){
    fd.append( "file", $("input[name='file']").prop("files")[0] );
    $.ajax({
      type: "POST",
      url: '/api/file',
      dataType: "text",
      data: fd,
      processData: false,
      contentType: false,
      success: function( result ){
        //console.log( result );
        location.href = '/';
      },
      error: function( e0, e1, e2 ){
        console.log( e1 + " : " + e2 );
      }
    });
  }

  return false;
}

function delFile( id ){
  if( window.confirm( 'ID: ' + id + ' のファイルを削除します' ) ){
    var obj = getBusyOverlay( 'viewport', { color:'black', opacity:0.5, text:'削除中', style:'text-decoration:blink;font-weight:bold;font-size:12px;color:white' } );
    $.ajax({
      type: "DELETE",
      url: "/api/file/" + id,
      success: function( data ){
        obj.remove();
        //console.log( data );
        location.href = '/';
      },
      error: function( e0, e1, e2 ){
        obj.remove();
        console.log( e1 + " : " + e2 );
      }
    });
  }
}
</script>
</head>
<body>
  <!-- //navi -->
  <nav class="navbar navbar-default navbar-fixed-top">
    <div class="navbar-header">
      <a class="navbar-brand" href="./">Hash File Storage</a>
      <button class="navbar-toggle" data-toggle="collapse" data-target=".target">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
    </div>
    <div class="collapse navbar-collapse target">
      <ul class="nav navbar-nav navbar-right">
      	<li>
        </li>
      </ul>
    </div>
  </nav>
  <!-- navi// -->

  <!-- //list -->
  <div class="container" style="padding:60px 0;">
    <table class="table table-striped table-bordered">
      <thead>
        <tr style="background-color: #ffffcc;"><th>ID</th><th>Image</th><th>Actions</th></tr>
      </thead>
      <tbody id="table-body">
      </tbody>
    </table>
  </div>
  <!-- list// -->

</body>
</html>
